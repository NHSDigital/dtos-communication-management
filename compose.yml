name: communication-management

services:
  # External Dependencies
  azurite:
    container_name: azurite
    image: mcr.microsoft.com/azure-storage/azurite
    command: azurite --silent
    network_mode: host

  azurite-setup:
    container_name: azurite-setup
    build:
      context: ./
      dockerfile: ./dependencies/azurite/Dockerfile
    network_mode: host
    depends_on:
      - azurite
    environment:
      # See https://github.com/Azure/Azurite?tab=readme-ov-file#connection-strings for connection string
      - AZURITE_CONNECTION_STRING=${AZURITE_CONNECTION_STRING}

  # Functions
  process-pilot-data:
    container_name: process-pilot-data
    network_mode: host
    build:
      context: ./src/functions/process_pilot_data/
      dockerfile: Dockerfile
    environment:
      - AzureWebJobsStorage=UseDevelopmentStorage=true
      - ASPNETCORE_URLS=http://*:7071
      - FUNCTIONS_WORKER_RUNTIME=python
      - BLOB_CONTAINER_NAME=${BLOB_CONTAINER_NAME}
      - NOTIFICATION_FUNCTION_URL=http://localhost:7072/api/notify/message/send

    depends_on:
      - azurite

  notify:
    container_name: notify
    network_mode: host
    build:
      context: ./src/functions/notify/
      dockerfile: Dockerfile
    environment:
      - AzureWebJobsStorage=UseDevelopmentStorage=true
      - ASPNETCORE_URLS=http://*:7072
      - NOTIFY_API_URL=https://sandbox.api.service.nhs.uk
